name: Build and Push Frontend Docker Image

on:
    push:
        branches:
        - main
        tags:
        - 'v*.*.*'
    workflow_dispatch:

permissions:
    contents: write
    security-events: write

env:
    DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/doecerto-frontend

jobs:
    lint-and-test:
        runs-on: ubuntu-latest
        name: Lint & Test

        steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
              node-version: '22'
              cache: 'npm'

        - name: Install dependencies
          run: npm ci

        - name: Run linter
          run: npm run lint

        - name: Run tests
          run: npm test -- --passWithNoTests

    build-and-push:
        needs: lint-and-test
        runs-on: ubuntu-latest
        name: Build & Push

        steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Log in to Docker Hub
          uses: docker/login-action@v3
          with:
              username: ${{ secrets.DOCKERHUB_USERNAME }}
              password: ${{ secrets.DOCKERHUB_TOKEN }}

        - name: Extract metadata
          id: meta
          uses: docker/metadata-action@v5
          with:
              images: ${{ env.DOCKER_IMAGE }}
              tags: |
                  type=ref,event=branch
                  type=sha,event=branch,prefix=sha-
                  type=semver,pattern={{version}}
                  type=semver,pattern={{major}}.{{minor}}
                  type=semver,pattern={{major}}
                  type=raw,value=latest,enable={{is_default_branch}}

        - name: Build and push Docker image
          uses: docker/build-push-action@v5
          with:
              context: .
              push: true
              tags: ${{ steps.meta.outputs.tags }}
              labels: ${{ steps.meta.outputs.labels }}
              cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
              cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max

        - name: Run Trivy vulnerability scanner
          uses: aquasecurity/trivy-action@master
          continue-on-error: true
          with:
              image-ref: ${{ env.DOCKER_IMAGE }}:latest
              format: 'sarif'
              output: 'trivy-results.sarif'
              severity: 'CRITICAL,HIGH'

        - name: Upload Trivy results to GitHub Security tab
          uses: github/codeql-action/upload-sarif@v4
          if: hashFiles('trivy-results.sarif') != ''
          with:
              sarif_file: trivy-results.sarif
              category: trivy

    build-apk:
        needs: lint-and-test
        runs-on: ubuntu-latest
        name: Build APK (Release)
        if: startsWith(github.ref, 'refs/tags/')

        steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
              node-version: '22'
              cache: 'npm'

        - name: Setup Java
          uses: actions/setup-java@v4
          with:
              distribution: 'temurin'
              java-version: '21'

        - name: Install dependencies
          run: npm ci

        - name: Build Next.js for mobile
          run: npm run build

        - name: Sync Capacitor
          run: npx cap sync android

        - name: Build APK
          run: cd android && chmod +x ./gradlew && ./gradlew assembleRelease

        - name: Create Release
          uses: softprops/action-gh-release@v1
          with:
              files: android/app/build/outputs/apk/release/app-release-unsigned.apk
              draft: false
              prerelease: false
              generate_release_notes: true
          env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}