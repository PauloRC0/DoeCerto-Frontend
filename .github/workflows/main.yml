name: Build and Push Frontend Docker Image

on:
    push:
        branches:
        - main
        tags:
        - 'v*.*.*'
    workflow_dispatch:

permissions:
    contents: write
    security-events: write

env:
    DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/doecerto-frontend

jobs:
    lint-and-test:
        runs-on: ubuntu-latest
        name: Lint & Test

        steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
              node-version: '20'
              cache: 'npm'

        - name: Install dependencies
          run: npm ci

        - name: Run linter
          run: npm run lint

        - name: Run tests
          run: npm test -- --passWithNoTests

    build-and-push:
        needs: lint-and-test
        runs-on: ubuntu-latest
        name: Build & Push

        steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Log in to Docker Hub
          uses: docker/login-action@v3
          with:
              username: ${{ secrets.DOCKERHUB_USERNAME }}
              password: ${{ secrets.DOCKERHUB_TOKEN }}

        - name: Extract metadata
          id: meta
          uses: docker/metadata-action@v5
          with:
              images: ${{ env.DOCKER_IMAGE }}
              tags: |
                  type=ref,event=branch
                  type=semver,pattern={{version}}
                  type=semver,pattern={{major}}.{{minor}}
                  type=sha,prefix={{branch}}-

        - name: Build and push Docker image
          uses: docker/build-push-action@v5
          with:
              context: .
              push: true
              tags: ${{ steps.meta.outputs.tags }}
              labels: ${{ steps.meta.outputs.labels }}
              cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
              cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max

        - name: Run Trivy vulnerability scanner
          uses: aquasecurity/trivy-action@master
          with:
              image-ref: ${{ env.DOCKER_IMAGE }}:${{ github.ref_name }}
              format: 'sarif'
              output: 'trivy-results.sarif'
              severity: 'CRITICAL,HIGH'

        - name: Upload Trivy results to GitHub Security tab
          uses: github/codeql-action/upload-sarif@v3
          if: always()
          with:
              sarif: trivy-results.sarif
              
    build-apk:
        needs: lint-and-test
        runs-on: ubuntu-latest
        name: Build APK
        if: startsWith(github.ref, 'refs/tags/')

        steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
              node-version: '20'
              cache: 'npm'

        - name: Setup Java
          uses: actions/setup-java@v4
          with:
              distribution: 'temurin'
              java-version: '17'

        - name: Install dependencies
          run: npm ci

        - name: Build Next.js
          run: npm run build

        - name: Sync Capacitor
          run: npx capacitor sync android

        - name: Build APK
          run: cd android && ./gradlew assembleRelease

        - name: Sign APK (optional)
          run: echo "APK built successfully"

        - name: Create Release
          uses: softprops/action-gh-release@v1
          with:
              files: android/app/build/outputs/apk/release/app-release.apk
              draft: false
              prerelease: false
              generate_release_notes: true
          env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    build-apk-dev:
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
        steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
              node-version: '20'
              cache: 'npm'

        - name: Setup Java
          uses: actions/setup-java@v4
          with:
              distribution: 'temurin'
              java-version: '17'

        - name: Install dependencies
          run: npm ci

        - name: Build Next.js
          run: npm run build

        - name: Sync Capacitor
          run: npx capacitor sync android

        - name: Build APK
          run: cd android && ./gradlew assembleRelease

        - name: Sign APK (optional)
          run: echo "APK built successfully"

        - name: Upload APK (apenas para time)
          uses: actions/upload-artifact@v4
          with:
              name: app-debug-${{ github.sha }}
              path: android/app/build/outputs/apk/release/app-release.apk
              retention-days: 7